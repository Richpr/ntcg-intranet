{% extends 'intranet/base.html' %}
{% load static %}
{% block title %}Dashboard Team Lead{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1>Dashboard Team Lead</h1>

    <!-- Section Statistiques -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Statistiques</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group">
                        <li class="list-group-item">Total des tâches : <strong>{{ stats.total_tasks }}</strong></li>
                        <li class="list-group-item">Tâches en cours : <strong>{{ stats.in_progress_tasks }}</strong></li>
                        <li class="list-group-item">Tâches bientôt dues : <strong>{{ stats.due_soon_tasks }}</strong></li>
                        <li class="list-group-item">Sites assignés : <strong>{{ stats.sites_involved }}</strong></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>Répartition des tâches</h5>
                </div>
                <div class="card-body">
                    <canvas id="tasksChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Tâches Assignées -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Tâches Assignées ({{ assigned_tasks.count }})</h5>
                    <a href="{% url 'export_user_tasks_csv' %}" class="btn btn-success">Exporter en CSV</a>
                </div>
                <div class="card-body">
                    {% if assigned_tasks %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Titre</th>
                                    <th>Site</th>
                                    <th>Statut</th>
                                    <th>Échéance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in assigned_tasks %}
                                    <tr>
                                        <td>{{ task.title }}</td>
                                        <td>{{ task.site.name }}</td>
                                        <td>
                                            <span class="badge bg-{% if task.status == 'TERMINÉ' %}success{% elif task.status == 'EN COURS' %}warning{% else %}secondary{% endif %}">
                                                {{ task.status }}
                                            </span>
                                        </td>
                                        <td>{{ task.due_date|date:"d M Y"|default:"Non définie" }}</td>
                                        <td>
                                            <a href="{% url 'update_task_progress' task.id %}" class="btn btn-sm btn-primary">Mettre à jour</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">Aucune tâche assignée.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Section Sites Assignés (Tableau) -->
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>Sites Auxquels Je Suis Assigné ({{ sites_involved.count }})</h5>
                    <a href="{% url 'team_lead_sites' %}" class="btn btn-link">Voir tous les sites</a>
                </div>
                <div class="card-body">
                    {% if sites_involved %}
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nom du Site</th>
                                    <th>Projet</th>
                                    <th>Localisation</th>
                                    <th>Tâches</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for site in sites_involved %}
                                    <tr>
                                        <td>{{ site.name }}</td>
                                        <td>{{ site.project.name }}</td>
                                        <td>{{ site.location|default:"Non spécifiée" }}</td>
                                        <td>{{ site.task_count }}</td>
                                        <td>
                                            <a href="{% url 'site_detail' site.id %}" class="btn btn-sm btn-primary">Détails</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p class="text-muted">Aucun site assigné pour le moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('tasksChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {{ chart_data|safe }},
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Nombre de tâches' }
                    }
                },
                plugins: {
                    legend: { display: true },
                    title: { display: true, text: 'Statistiques des tâches' }
                }
            }
        });
    });
</script>
{% endblock %}